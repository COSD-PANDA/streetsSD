<!DOCTYPE html>
<html>
  <head>
    <title>Layer selector example | CartoDB.js</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" />
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.13/themes/css/cartodb.css" />
    <link rel="stylesheet" href="main.css" />
  </head>
  <body>
    <div id="map"></div>
    <div id="helper_box" class="cartodb-infobox" style="display:none">
      <div id="all_work" class="helper_section" style="display:none">
        <h3> All Work </h3>
        <p>
          All Work
        </p>
      </div>

      <div id="past_work" class="helper_section" style="display:none">
        <h3> Past Work </h3>
        <p>
          Paving that has occurred since October 12, 2011
        </p>
      </div>
      <div id="future_work" class="helper_section" style="display:none">
        <h3> Future Work </h3>
        <p>
          For future work – “Paving anticipated to occur through February 20, 2020
        </p>
      </div>
       <div id="oci_2011" class="helper_section" style="display:none">
        <h3> OCI </h3>
        <p>
          This is a streets condition assessment that was performed in 2011.  We are doing one again this year, and once we have it, we will publish the results. (link to article?);
        </p>
      </div>

    </div>
    <div id="layer_selector" class="cartodb-infobox">
      <ul id="work-layers">
        <li id="all_work" data-sublayer="0" data-sql="all_work">All Work</li>
        <li id="past_work" data-sublayer="0" data-sql="past_work">Past Work</li>
        <li id="future_work" data-sublayer="0" data-sql="future_work">Future Work</li>
        <li id="oci_2011" data-sublayer="1">OCI as of 2011</li>
      </ul>
      <!--<ul id="opt-layers">
        <li>
          <input type="checkbox" name="Show Districts" value="0">Show Council Districts</input>
        </li>
      </ul>-->

    <!-- include cartodb.js library -->
    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.13/cartodb.js"></script>

    <script>
      var global = {
        workLayers: {}
      };

      function getSQL(sqlKey) {
        var SQL = "SELECT spp2.cartodb_id," +
          "spp2.the_geom_webmercator, " +
          "spp2.activity, " +
          "spp2.est_date, " +
          "spp2.date_, " +
          "COALESCE(to_char(spp2.est_date, 'Month DD, YYYY'), to_char(spp2.date_, 'Month DD, YYYY')) AS date_text," +
          "spp2.shape_len, " +
          "spp2.rd20full, " +
          "spp2.xstrt1, " +
          "spp2.xstrt2, "+
          "spp2.district "+
          "FROM spp2 ";
        switch (sqlKey) {
          case 'all_work':
            SQL += "WHERE spp2.date_ is not null OR spp2.est_date is not null";
            break;

          case 'past_work':
            SQL += "WHERE spp2.date_ is not null";
            break;

          case 'future_work':
            SQL += "WHERE spp2.est_date is not null";
            break;
        }
        return SQL;
      }

      function clearState() {
        $('#helper_box, .helper_section').hide();
        var num_sublayers = global.layers[1].getSubLayerCount();
        for (var i = 0; i < num_sublayers; i++)
          global.layers[1].getSubLayer(i).hide();

      }


      function initSubLayerWatch() {
        clearState();
        var $optLayers = $('#layer_selector ul#opt-layers li');
        $optLayers.click(function(e) {
          var $li = $(e.target);
          var $input = $('input', $li);
          $input.prop('checked') == true ? $input.prop('checked', false) : $input.prop('checked', true);
          var subLayer = global.layers[1].getSubLayer(0);
          subLayer.toggle();
        });

        var $workLayers = $('#layer_selector ul#work-layers li');
        $workLayers.click(function(e) {
          // get the area of the selected layer
          var $li = $(e.target);
          var subLayerNum = $li.attr('data-sublayer');
          var subLayerSQL = $li.attr('data-sql') || null;
          var subLayerID = $li.attr('id');
          clearState();
          var subLayer = global.layers[1].getSubLayer(subLayerNum);
          console.log(getSQL(subLayerSQL));

          if (subLayerSQL)
            subLayer.setSQL(getSQL(subLayerSQL));

          subLayer.show();
          $('#helper_box').show();
          $('#helper_box #' + subLayerID).show();

          // deselect all and select the clicked one
          $workLayers.removeClass('selected');
          $li.addClass('selected');
        });
      }

       function main() {
        cartodb.createVis('map', 'https://maksim2.cartodb.com/api/v2/viz/1387c31c-e546-11e4-a74b-0e853d047bba/viz.json', {
          tiles_loader: true,
          center_lat: 32.7150,
          center_lon: -117.1625,
          zoom: 10
        })
        .done(function(vis, layers) {
          global.vis = vis;
          global.layers = layers;
          initSubLayerWatch();
        })
        .error(function(err) {
          console.log(err);
        });
      }

      window.onload = main;
    </script>
  </body>
</html>
